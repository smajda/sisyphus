(function(b){b.sisyphus=function(){return Sisyphus.getInstance()};b.fn.sisyphus=function(b){var e=Sisyphus.getInstance();e.setOptions(b);e.protect(this);return e};var i={isAvailable:function(){if("object"===typeof b.jStorage)return!0;try{return localStorage.getItem}catch(c){return!1}},set:function(c,e){if("object"===typeof b.jStorage)b.jStorage.set(c,e+"");else try{localStorage.setItem(c,e+"")}catch(h){}},get:function(c){return"object"===typeof b.jStorage?(c=b.jStorage.get(c))?c.toString():c:localStorage.getItem(c)},
remove:function(c){"object"===typeof b.jStorage?b.jStorage.deleteKey(c):localStorage.removeItem(c)}};Sisyphus=function(){var c,e;function h(){return{setInitialOptions:function(a){var f={excludeFields:null,customKey:"",customKeyPrefix:"",timeout:0,autoRelease:!0,onSave:function(){},onRestore:function(){},onRelease:function(){}};this.options=this.options||b.extend(f,a);this.browserStorage=i},setOptions:function(a){this.options=this.options||this.setInitialOptions(a);this.options=b.extend(this.options,
a)},protect:function(a){a=a||{};this.targets=this.targets||[];this.href=this.options.customKey?this.options.customKey:location.hostname+location.pathname+location.search;this.targets=b.merge(this.targets,a);this.targets=b.unique(this.targets);this.targets=b(this.targets);if(!this.browserStorage.isAvailable())return!1;this.restoreAllData();this.options.autoRelease&&this.bindReleaseData();c||(this.bindSaveData(),c=!0)},bindSaveData:function(){var a=this;a.options.timeout&&a.saveDataByTimeout();a.targets.each(function(){var f=
b(this).attr("id");b(this).find(":input").not(":submit").not(":reset").not(":button").each(function(){if(-1!==b.inArray(this,a.options.excludeFields))return!0;var d=b(this),c=a.href+f+d.attr("name")+a.options.customKeyPrefix;d.is(":text")||d.is("textarea")?a.options.timeout||a.bindSaveDataImmediately(d,c):a.bindSaveDataOnChange(d,c)})})},saveAllData:function(){var a=this;a.targets.each(function(){var f=b(this).attr("id");b(this).find(":input").not(":submit").not(":reset").not(":button").each(function(){if(-1!==
b.inArray(this,a.options.excludeFields))return!0;var d=b(this),c=a.href+f+d.attr("name")+a.options.customKeyPrefix,g=d.val();d.is(":checkbox")?(-1!=d.attr("name").indexOf("[")?(g=[],b("[name='"+d.attr("name")+"']:checked").each(function(){g.push(b(this).val())})):g=d.is(":checked"),a.saveToBrowserStorage(c,g,!1)):d.is(":radio")?d.is(":checked")&&(g=d.val(),a.saveToBrowserStorage(c,g,!1)):a.saveToBrowserStorage(c,g,!1)})});b.isFunction(a.options.onSave)&&a.options.onSave.call()},restoreAllData:function(){var a=
this,f=!1;a.targets.each(function(){var d=b(this),c=d.attr("id");d.find(":input").not(":submit").not(":reset").not(":button").each(function(){if(-1!==b.inArray(this,a.options.excludeFields))return!0;var d=b(this),e=a.href+c+d.attr("name")+a.options.customKeyPrefix;if(e=a.browserStorage.get(e))a.restoreFieldsData(d,e),f=!0})});f&&b.isFunction(a.options.onRestore)&&a.options.onRestore.call()},restoreFieldsData:function(a,b){a.is(":checkbox")&&"false"!==b&&-1===a.attr("name").indexOf("[")?a.attr("checked",
"checked"):a.is(":radio")?a.val()===b&&a.attr("checked","checked"):(-1!==a.attr("name").indexOf("[")&&(b=b.split(",")),a.val(b))},bindSaveDataImmediately:function(a,f){var d=this;null==b.browser.msie?a.get(0).oninput=function(){d.saveToBrowserStorage(f,a.val())}:a.get(0).onpropertychange=function(){d.saveToBrowserStorage(f,a.val())}},saveToBrowserStorage:function(a,f,d){d=null==d?!0:d;this.browserStorage.set(a,f);d&&""!==f&&b.isFunction(this.options.onSave)&&this.options.onSave.call()},bindSaveDataOnChange:function(a){var b=
this;a.change(function(){b.saveAllData()})},saveDataByTimeout:function(){var a=this;setTimeout(function(){function b(){a.saveAllData();setTimeout(b,1E3*a.options.timeout)}return b}(a.targets),1E3*a.options.timeout)},bindReleaseData:function(){var a=this;a.targets.each(function(){var c=b(this),d=c.find(":input").not(":submit").not(":reset").not(":button"),e=c.attr("id");b(this).bind("submit reset",function(){a.releaseData(e,d)})})},manuallyReleaseData:function(){var a=this;a.targets.each(function(){var c=
b(this),d=c.find(":input").not(":submit").not(":reset").not(":button"),c=c.attr("id");a.releaseData(c,d)})},releaseData:function(a,c){var d=!1,e=this;c.each(function(){if(-1!==b.inArray(this,e.options.excludeFields))return!0;var c=b(this),c=e.href+a+c.attr("name")+e.options.customKeyPrefix;e.browserStorage.remove(c);d=!0});d&&b.isFunction(e.options.onRelease)&&e.options.onRelease.call()}}}e=null;c=null;return{getInstance:function(){e||(e=h(),e.setInitialOptions());return e},free:function(){c=void 0;
e=void 0;return null}}}()})(jQuery);
